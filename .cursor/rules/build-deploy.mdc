---
description:
globs:
alwaysApply: false
---
---
description: Build system and deployment guidelines for GraphJin
alwaysApply: false
---

# Build and Deployment Guidelines

## Build System

GraphJin uses a comprehensive Makefile-based build system supporting multiple platforms and deployment targets.

### Core Build Commands

```bash
# Build for current platform
make build

# Build for all platforms (Linux, macOS, Windows)
make release

# Install locally
make install

# Run development server
make run ARGS="serv"

# Run tests
make test

# Generate code
make gen

# Lint code
make lint
```

### Build Variables

The build system uses Git-based versioning:

```makefile
BUILD         = $(shell git rev-parse --short HEAD)
BUILD_DATE    = $(shell git log -1 --format=%ci)
BUILD_BRANCH  = $(shell git rev-parse --abbrev-ref HEAD)
BUILD_VERSION = $(shell git describe --always --tags)
```

### Cross-Platform Builds

Supports multiple architectures:
- `linux/amd64` - Linux 64-bit
- `windows/amd64` - Windows 64-bit  
- `darwin/amd64` - macOS 64-bit

## Version Management

### Semantic Versioning

GraphJin follows semantic versioning (currently v3.0.26):
- **Major** (3.x.x) - Breaking changes
- **Minor** (x.1.x) - New features, backward compatible
- **Patch** (x.x.1) - Bug fixes, backward compatible

### Automatic Releases

The repository includes automatic release management:

#### Version Increment Rules
- `[major]` in commit message → major version bump
- `feat:`, `feature:`, `[minor]` → minor version bump
- Default → patch version bump
- `[skip-release]` → skip automatic release

#### Release Process
1. Version increment based on commit message
2. Update all Go modules with new version
3. Update package.json version
4. Create Git tags for all modules
5. Trigger build and release pipeline

## Multi-Target Releases

### Binary Releases
- Native binaries for Linux, macOS, Windows
- Signed releases with GPG
- Checksums for verification

### Package Managers
- **Homebrew** - macOS package manager
- **Scoop** - Windows package manager
- **Snap** - Universal Linux packages
- **APT/RPM** - Debian and RedHat packages

### Container Images
- Docker images for multiple architectures
- Multi-stage builds for optimal size
- Health checks and proper signal handling

### Language Packages
- **npm** - NodeJS package with WASM binary
- **Go modules** - Native Go library support

## WebAssembly Build

### WASM Compilation
```bash
# Build WASM binary
make wasm-build

# Build process
GOOS=js GOARCH=wasm go build -o ./wasm/graphjin.wasm ./wasm/*.go
```

### NodeJS Integration
- WASM binary packaged with JavaScript wrapper
- Automatic installation with `npm install graphjin`
- Support for both CommonJS and ES modules

## Development Workflow

### Local Development
```bash
# Setup development environment
git clone https://github.com/dosco/graphjin
cd graphjin
make install

# Run development server
make run ARGS="serv --config=./examples/webshop/config"
```

### Testing Before Release
```bash
# Run comprehensive tests
make test

# Run linting
make lint

# Test cross-platform builds
make release
```

### Hot Reloading
- File watching for configuration changes
- Automatic query reloading in development
- Live schema updates

## Deployment Strategies

### Standalone Service
```bash
# Download and install
brew install dosco/graphjin/graphjin

# Create new project
graphjin new myapp

# Deploy configuration
graphjin deploy --host=https://server.com --secret="key"
```

### Docker Deployment
```dockerfile
FROM dosco/graphjin:latest
COPY config/ /config/
EXPOSE 8080
CMD ["serv"]
```

### Kubernetes Deployment
- Helm charts for easy deployment
- ConfigMaps for configuration management
- Secrets for sensitive data
- Health checks and rolling updates

### Library Integration

#### Go Library
```go
import "github.com/dosco/graphjin/core/v3"

gj, err := core.NewGraphJin(config, db)
```

#### NodeJS Library
```javascript
import graphjin from "graphjin";

const gj = await graphjin("./config", "dev.yml", db);
```

## Configuration Management

### Environment-Specific Configs
- `dev.yml` - Development settings
- `prod.yml` - Production settings
- Environment variable overrides
- Secrets management

### Production Considerations
- Enable production mode for security
- Use environment variables for secrets
- Configure proper logging levels
- Set up monitoring and alerting

## Monitoring and Observability

### Metrics
- Prometheus metrics export
- Custom business metrics
- Performance monitoring
- Error rate tracking

### Tracing
- OpenTelemetry integration
- Distributed tracing support
- Request correlation IDs
- Performance profiling

### Logging
- Structured logging with levels
- Request/response logging
- Error logging with context
- Audit logging for security events

## Security Considerations

### Production Security
- All queries pre-saved and validated
- No dynamic query execution
- Role-based access control
- Rate limiting and DDoS protection

### Build Security
- Signed releases with GPG
- Dependency vulnerability scanning
- Secure build environments
- Supply chain security

## Performance Optimization

### Build Optimization
- Stripped binaries (`-s -w` flags)
- Minimal Docker images
- Efficient WASM builds
- Optimized for size and speed

### Runtime Optimization
- Connection pooling
- Query caching
- Prepared statements
- Memory management

## Troubleshooting

### Common Build Issues
- Go version compatibility
- Missing dependencies
- Cross-compilation errors
- WASM build problems

### Deployment Issues
- Configuration validation
- Database connectivity
- Permission problems
- Resource constraints
